<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SynerX Video Upload Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .upload-section {
        border: 2px dashed #ccc;
        padding: 40px;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 20px;
        background-color: #fafafa;
      }
      .upload-section.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }
      #fileInput {
        display: none;
      }
      .upload-btn {
        background-color: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }
      .upload-btn:hover {
        background-color: #0056b3;
      }
      .upload-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .shutdown-btn {
        background-color: #dc3545;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }
      .shutdown-btn:hover {
        background-color: #c82333;
      }
      .status-btn {
        background-color: #28a745;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }
      .status-btn:hover {
        background-color: #218838;
      }
      .progress {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
        display: none;
      }
      .progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
      }
      .result.success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .result.error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .result.info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      .file-info {
        margin: 10px 0;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        display: none;
      }
      .api-url {
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 5px;
        border-radius: 3px;
        margin: 5px 0;
      }
      .controls {
        text-align: center;
        margin: 20px 0;
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🚗 SynerX Video Upload Test</h1>

      <div class="api-url">
        <strong>API URL:</strong> https://synerx-6x96.onrender.com
      </div>

      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <h3>📹 Upload Video for Processing</h3>
        <p>Drag and drop a video file here or click to select</p>
        <input type="file" id="fileInput" accept="video/*" />
        <button
          class="upload-btn"
          onclick="document.getElementById('fileInput').click()"
        >
          Choose Video File
        </button>
        <div class="file-info" id="fileInfo"></div>
      </div>

      <!-- Progress Bar -->
      <div class="progress" id="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Loading Spinner -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing video... This may take a few minutes</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button
          class="upload-btn"
          id="uploadBtn"
          onclick="uploadVideo()"
          disabled
        >
          🚀 Start Processing
        </button>
        <button class="status-btn" onclick="checkStatus()">
          📊 Check Status
        </button>
        <button class="shutdown-btn" onclick="shutdownProcessing()">
          🛑 Shutdown Processing
        </button>
      </div>

      <!-- Result Display -->
      <div class="result" id="result"></div>
    </div>

    <script>
      const API_BASE_URL = "https://synerx-6x96.onrender.com";
      let selectedFile = null;

      // File selection handling
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          selectedFile = e.target.files[0];
          if (selectedFile) {
            displayFileInfo(selectedFile);
            document.getElementById("uploadBtn").disabled = false;
          }
        });

      // Drag and drop handling
      const uploadSection = document.getElementById("uploadSection");

      uploadSection.addEventListener("dragover", function (e) {
        e.preventDefault();
        uploadSection.classList.add("dragover");
      });

      uploadSection.addEventListener("dragleave", function (e) {
        e.preventDefault();
        uploadSection.classList.remove("dragover");
      });

      uploadSection.addEventListener("drop", function (e) {
        e.preventDefault();
        uploadSection.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          selectedFile = files[0];
          if (selectedFile.type.startsWith("video/")) {
            displayFileInfo(selectedFile);
            document.getElementById("uploadBtn").disabled = false;
          } else {
            showResult("Please select a valid video file", "error");
          }
        }
      });

      function displayFileInfo(file) {
        const fileInfo = document.getElementById("fileInfo");
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        fileInfo.innerHTML = `
                <strong>Selected File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${sizeMB} MB<br>
                <strong>Type:</strong> ${file.type}
            `;
        fileInfo.style.display = "block";
      }

      async function uploadVideo() {
        if (!selectedFile) {
          showResult("Please select a video file first", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", selectedFile);

        // Show loading state
        document.getElementById("loading").style.display = "block";
        document.getElementById("progress").style.display = "block";
        document.getElementById("uploadBtn").disabled = true;
        showResult("Starting video upload and processing...", "info");

        try {
          const response = await fetch(`${API_BASE_URL}/upload-video/`, {
            method: "POST",
            body: formData,
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          // Hide loading
          document.getElementById("loading").style.display = "none";
          document.getElementById("progress").style.display = "none";
          document.getElementById("uploadBtn").disabled = false;

          // Display results
          let resultHtml = `
                    <h3>✅ Processing Complete!</h3>
                    <p><strong>Processing Time:</strong> ${result.processing_stats.processing_time.toFixed(
                      2
                    )}s</p>
                    <p><strong>Total Vehicles:</strong> ${
                      result.processing_stats.total_vehicles
                    }</p>
                    <p><strong>Compliance Rate:</strong> ${result.processing_stats.compliance_rate.toFixed(
                      2
                    )}%</p>
                `;

          if (result.processed_video_url) {
            resultHtml += `<p><strong>Processed Video:</strong> <a href="${result.processed_video_url}" target="_blank">Download</a></p>`;
          }

          if (result.tracking_data && result.tracking_data.length > 0) {
            resultHtml += `<p><strong>Tracking Records:</strong> ${result.tracking_data.length}</p>`;
          }

          if (result.vehicle_counts && result.vehicle_counts.length > 0) {
            resultHtml += `<p><strong>Vehicle Counts:</strong> ${result.vehicle_counts.length}</p>`;
          }

          showResult(resultHtml, "success");
        } catch (error) {
          document.getElementById("loading").style.display = "none";
          document.getElementById("progress").style.display = "none";
          document.getElementById("uploadBtn").disabled = false;
          showResult(`Error: ${error.message}`, "error");
        }
      }

      async function checkStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/status/`, {
            mode: "cors",
          });
          const result = await response.json();

          let statusHtml = `
                    <h3>📊 Processing Status</h3>
                    <p><strong>Processing Active:</strong> ${
                      result.processing_active ? "Yes" : "No"
                    }</p>
                    <p><strong>Shutdown Requested:</strong> ${
                      result.shutdown_requested ? "Yes" : "No"
                    }</p>
                    <p><strong>Processing Time:</strong> ${result.processing_time.toFixed(
                      2
                    )}s</p>
                `;

          showResult(statusHtml, "info");
        } catch (error) {
          showResult(`Error checking status: ${error.message}`, "error");
        }
      }

      async function shutdownProcessing() {
        if (
          confirm("Are you sure you want to shutdown the current processing?")
        ) {
          try {
            const response = await fetch(`${API_BASE_URL}/shutdown/`, {
              method: "POST",
              mode: "cors",
            });
            const result = await response.json();

            showResult(
              `Shutdown requested. Processing time: ${result.processing_time.toFixed(
                2
              )}s`,
              "info"
            );
          } catch (error) {
            showResult(`Error shutting down: ${error.message}`, "error");
          }
        }
      }

      function showResult(message, type) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = message;
        resultDiv.className = `result ${type}`;
        resultDiv.style.display = "block";
      }

      // Test database connection on page load
      window.addEventListener("load", async function () {
        try {
          const response = await fetch(`${API_BASE_URL}/test-db/`);
          const result = await response.json();

          if (result.status === "success") {
            showResult(
              `✅ Database connection successful! Tracking records: ${result.tracking_data_count}, Vehicle counts: ${result.vehicle_counts_count}`,
              "success"
            );
          } else {
            showResult(
              `⚠️ Database connection issue: ${result.error}`,
              "error"
            );
          }
        } catch (error) {
          showResult(`❌ Cannot connect to API: ${error.message}`, "error");
        }
      });
    </script>
  </body>
</html>
