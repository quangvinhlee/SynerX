<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Road Safety Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.8;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 40px;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
      }

      .section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .chart-container h3 {
        text-align: center;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .insight-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #3498db;
      }

      .insight-card.warning {
        border-left-color: #e74c3c;
      }

      .insight-card.info {
        border-left-color: #f39c12;
      }

      .insight-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .insight-message {
        color: #555;
        margin-bottom: 10px;
      }

      .insight-suggestion {
        color: #3498db;
        font-style: italic;
      }

      .filters {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .filter-group {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-group label {
        font-weight: bold;
        color: #2c3e50;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .filter-group button {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .filter-group button:hover {
        background: #2980b9;
      }

      .data-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .data-table th {
        background: #2c3e50;
        color: white;
        font-weight: bold;
      }

      .data-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .data-table tr:hover {
        background: #e3f2fd;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .heatmap-container {
        width: 100%;
        height: 300px;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .heatmap-row {
        display: flex;
        gap: 2px;
        height: 40px;
      }

      .heatmap-cell {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .heatmap-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .heatmap-header {
        display: flex;
        gap: 2px;
        margin-bottom: 10px;
      }

      .heatmap-header-cell {
        flex: 1;
        text-align: center;
        font-weight: bold;
        color: #2c3e50;
        font-size: 14px;
      }

      .heatmap-y-labels {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-right: 10px;
        min-width: 80px;
      }

      .heatmap-y-label {
        height: 40px;
        display: flex;
        align-items: center;
        font-weight: bold;
        color: #2c3e50;
        font-size: 14px;
      }

      .heatmap-content {
        display: flex;
        flex: 1;
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .insights-grid {
          grid-template-columns: 1fr;
        }

        .filter-group {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöó Road Safety Analytics Dashboard</h1>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalVehicles">-</div>
            <div class="stat-label">Total Vehicles</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="overallCompliance">-</div>
            <div class="stat-label">Overall Compliance</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgReactionTime">-</div>
            <div class="stat-label">Avg Reaction Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="weatherConditions">-</div>
            <div class="stat-label">Weather Conditions</div>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- Filters Section -->
        <div class="filters">
          <h2>üîç Data Filters</h2>
          <div class="filter-group">
            <label>Weather Condition:</label>
            <select id="weatherFilter">
              <option value="">All Weather</option>
              <option value="clear">Clear</option>
              <option value="cloudy">Cloudy</option>
              <option value="foggy">Foggy</option>
              <option value="rainy">Rainy</option>
            </select>

            <label>Vehicle Type:</label>
            <select id="vehicleFilter">
              <option value="">All Vehicles</option>
              <option value="car">Car</option>
              <option value="truck">Truck</option>
            </select>

            <label>Compliance:</label>
            <select id="complianceFilter">
              <option value="">All</option>
              <option value="1">Compliant</option>
              <option value="0">Non-Compliant</option>
            </select>

            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="loadData()">Refresh Data</button>
          </div>
        </div>

        <!-- Weather Analysis Section -->
        <div class="section">
          <h2>üå§Ô∏è Weather Impact Analysis</h2>
          <div class="charts-grid">
            <div class="chart-container">
              <h3>Weather Compliance Rates</h3>
              <canvas id="weatherComplianceChart"></canvas>
            </div>
            <div class="chart-container">
              <h3>Weather Reaction Times</h3>
              <canvas id="weatherReactionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Vehicle Analysis Section -->
        <div class="section">
          <h2>üöõ Vehicle Type Analysis</h2>
          <div class="charts-grid">
            <div class="chart-container">
              <h3>Vehicle Compliance Comparison</h3>
              <canvas id="vehicleChart"></canvas>
            </div>
            <div class="chart-container">
              <h3>Vehicle Distribution</h3>
              <canvas id="vehicleDistributionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Time Analysis Section -->
        <div class="section">
          <h2>‚è∞ Time-based Analysis</h2>
          <div class="charts-grid">
            <div class="chart-container">
              <h3>Hourly Compliance Rates</h3>
              <canvas id="hourlyChart"></canvas>
            </div>
            <div class="chart-container">
              <h3>Traffic Volume by Hour</h3>
              <canvas id="trafficVolumeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Heatmap Section -->
        <div class="section">
          <h2>üî• Correlation Heatmap</h2>
          <div class="charts-grid">
            <div class="chart-container">
              <h3>Weather vs Vehicle Type Heatmap</h3>
              <div id="weatherVehicleHeatmap" class="heatmap-container"></div>
            </div>
            <div class="chart-container">
              <h3>Time vs Weather Heatmap</h3>
              <div id="timeWeatherHeatmap" class="heatmap-container"></div>
            </div>
          </div>
        </div>

        <!-- Insights Section -->
        <div class="section">
          <h2>üí° Actionable Insights</h2>
          <div class="insights-grid" id="insightsContainer">
            <!-- Dynamic insights will be loaded here -->
          </div>
        </div>

        <!-- Data Table Section -->
        <div class="section">
          <h2>üìä Raw Data</h2>
          <div class="data-table">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Vehicle Type</th>
                  <th>Status</th>
                  <th>Compliance</th>
                  <th>Reaction Time</th>
                  <th>Weather</th>
                  <th>Temperature</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <!-- Dynamic data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let analysisData = null;
      let filteredData = null;

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadData();
      });

      // Load correlation analysis data
      async function loadData() {
        try {
          showLoading();

          // Load correlation analysis
          const response = await fetch(
            "http://localhost:8000/correlation-analysis/"
          );
          const data = await response.json();

          if (data.status === "success") {
            analysisData = data.analysis;
            updateDashboard(data.analysis);
            updateStats(data.data_points);
          } else {
            showError("Failed to load correlation analysis data");
          }

          // Load raw data
          await loadRawData();
        } catch (error) {
          console.error("Error loading data:", error);
          showError(
            "Failed to connect to the server. Make sure the backend is running."
          );
        }
      }

      // Load raw tracking data
      async function loadRawData() {
        try {
          const response = await fetch(
            "http://localhost:8000/tracking-data/?limit=50"
          );
          const data = await response.json();

          if (data.status === "success") {
            updateDataTable(data.data);
          }
        } catch (error) {
          console.error("Error loading raw data:", error);
        }
      }

      // Update dashboard with analysis data
      function updateDashboard(data) {
        createWeatherCharts(data.weather_analysis);
        createVehicleCharts(data.basic_correlations);
        createTimeCharts(data.basic_correlations);
        createHeatmaps(data);
        createInsights(data.recommendations);
      }

      // Create weather analysis charts
      function createWeatherCharts(weatherData) {
        // Weather Compliance Chart
        const complianceCtx = document
          .getElementById("weatherComplianceChart")
          .getContext("2d");
        new Chart(complianceCtx, {
          type: "bar",
          data: {
            labels: Object.keys(weatherData.weather_compliance),
            datasets: [
              {
                label: "Compliance Rate (%)",
                data: Object.values(weatherData.weather_compliance).map(
                  (item) => item.mean * 100
                ),
                backgroundColor: ["#4CAF50", "#FF9800", "#9C27B0", "#2196F3"],
                borderColor: ["#388E3C", "#F57C00", "#7B1FA2", "#1976D2"],
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });

        // Weather Reaction Time Chart
        const reactionCtx = document
          .getElementById("weatherReactionChart")
          .getContext("2d");
        new Chart(reactionCtx, {
          type: "line",
          data: {
            labels: Object.keys(weatherData.weather_reaction_time),
            datasets: [
              {
                label: "Average Reaction Time (seconds)",
                data: Object.values(weatherData.weather_reaction_time).map(
                  (item) => item.mean
                ),
                borderColor: "#FF5722",
                backgroundColor: "rgba(255, 87, 34, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Seconds",
                },
              },
            },
          },
        });
      }

      // Create vehicle analysis charts
      function createVehicleCharts(basicData) {
        // Vehicle Compliance Chart
        const vehicleCtx = document
          .getElementById("vehicleChart")
          .getContext("2d");
        new Chart(vehicleCtx, {
          type: "doughnut",
          data: {
            labels: Object.keys(basicData.vehicle_type_compliance).map(
              (type) =>
                `${type.charAt(0).toUpperCase() + type.slice(1)} (${(
                  basicData.vehicle_type_compliance[type].mean * 100
                ).toFixed(1)}%)`
            ),
            datasets: [
              {
                data: Object.values(basicData.vehicle_type_compliance).map(
                  (item) => item.mean * 100
                ),
                backgroundColor: ["#4CAF50", "#F44336"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });

        // Vehicle Distribution Chart
        const distributionCtx = document
          .getElementById("vehicleDistributionChart")
          .getContext("2d");
        new Chart(distributionCtx, {
          type: "pie",
          data: {
            labels: Object.keys(basicData.vehicle_type_compliance),
            datasets: [
              {
                data: Object.values(basicData.vehicle_type_compliance).map(
                  (item) => item.count
                ),
                backgroundColor: ["#2196F3", "#FF9800"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      // Create time analysis charts
      function createTimeCharts(basicData) {
        // Hourly Compliance Chart
        const hourlyCtx = document
          .getElementById("hourlyChart")
          .getContext("2d");
        new Chart(hourlyCtx, {
          type: "bar",
          data: {
            labels: Object.keys(basicData.hour_compliance),
            datasets: [
              {
                label: "Compliance Rate (%)",
                data: Object.values(basicData.hour_compliance).map(
                  (item) => item.mean * 100
                ),
                backgroundColor: "rgba(52, 152, 219, 0.8)",
                borderColor: "#3498db",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Hour of Day",
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });

        // Traffic Volume Chart
        const volumeCtx = document
          .getElementById("trafficVolumeChart")
          .getContext("2d");
        new Chart(volumeCtx, {
          type: "line",
          data: {
            labels: Object.keys(basicData.hour_compliance),
            datasets: [
              {
                label: "Traffic Volume",
                data: Object.values(basicData.hour_compliance).map(
                  (item) => item.count
                ),
                borderColor: "#27AE60",
                backgroundColor: "rgba(39, 174, 96, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Vehicles",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Hour of Day",
                },
              },
            },
          },
        });
      }

      // Create heatmap charts
      function createHeatmaps(data) {
        // Weather vs Vehicle Type Heatmap
        const weatherVehicleContainer = document.getElementById(
          "weatherVehicleHeatmap"
        );
        const weatherTypes = Object.keys(
          data.weather_analysis.weather_compliance
        );
        const vehicleTypes = Object.keys(
          data.basic_correlations.vehicle_type_compliance
        );

        // Create header
        const header = document.createElement("div");
        header.className = "heatmap-header";
        header.innerHTML = '<div class="heatmap-header-cell"></div>';
        weatherTypes.forEach((weather) => {
          header.innerHTML += `<div class="heatmap-header-cell">${weather}</div>`;
        });
        weatherVehicleContainer.appendChild(header);

        // Create content
        const content = document.createElement("div");
        content.className = "heatmap-content";

        // Y-axis labels
        const yLabels = document.createElement("div");
        yLabels.className = "heatmap-y-labels";
        vehicleTypes.forEach((vehicle) => {
          yLabels.innerHTML += `<div class="heatmap-y-label">${vehicle}</div>`;
        });
        content.appendChild(yLabels);

        // Heatmap grid
        const grid = document.createElement("div");
        grid.style.display = "flex";
        grid.style.flexDirection = "column";
        grid.style.gap = "2px";
        grid.style.flex = "1";

        vehicleTypes.forEach((vehicle) => {
          const row = document.createElement("div");
          row.className = "heatmap-row";

          weatherTypes.forEach((weather) => {
            // Calculate correlation based on compliance rates
            const weatherCompliance =
              data.weather_analysis.weather_compliance[weather].mean;
            const vehicleCompliance =
              data.basic_correlations.vehicle_type_compliance[vehicle].mean;
            const correlation = (weatherCompliance + vehicleCompliance) / 2;

            const cell = document.createElement("div");
            cell.className = "heatmap-cell";
            cell.style.backgroundColor = `rgba(52, 152, 219, ${correlation})`;
            cell.textContent = `${(correlation * 100).toFixed(0)}%`;
            cell.title = `Weather: ${weather}, Vehicle: ${vehicle}, Correlation: ${(
              correlation * 100
            ).toFixed(1)}%`;

            row.appendChild(cell);
          });

          grid.appendChild(row);
        });

        content.appendChild(grid);
        weatherVehicleContainer.appendChild(content);

        // Time vs Weather Heatmap
        const timeWeatherContainer =
          document.getElementById("timeWeatherHeatmap");
        const hours = Object.keys(data.basic_correlations.hour_compliance);

        // Create header
        const timeHeader = document.createElement("div");
        timeHeader.className = "heatmap-header";
        timeHeader.innerHTML = '<div class="heatmap-header-cell"></div>';
        hours.forEach((hour) => {
          timeHeader.innerHTML += `<div class="heatmap-header-cell">${hour}:00</div>`;
        });
        timeWeatherContainer.appendChild(timeHeader);

        // Create content
        const timeContent = document.createElement("div");
        timeContent.className = "heatmap-content";

        // Y-axis labels
        const timeYLabels = document.createElement("div");
        timeYLabels.className = "heatmap-y-labels";
        weatherTypes.forEach((weather) => {
          timeYLabels.innerHTML += `<div class="heatmap-y-label">${weather}</div>`;
        });
        timeContent.appendChild(timeYLabels);

        // Heatmap grid
        const timeGrid = document.createElement("div");
        timeGrid.style.display = "flex";
        timeGrid.style.flexDirection = "column";
        timeGrid.style.gap = "2px";
        timeGrid.style.flex = "1";

        weatherTypes.forEach((weather) => {
          const row = document.createElement("div");
          row.className = "heatmap-row";

          hours.forEach((hour) => {
            // Calculate correlation based on compliance rates
            const hourCompliance =
              data.basic_correlations.hour_compliance[hour].mean;
            const weatherCompliance =
              data.weather_analysis.weather_compliance[weather].mean;
            const correlation = (hourCompliance + weatherCompliance) / 2;

            const cell = document.createElement("div");
            cell.className = "heatmap-cell";
            cell.style.backgroundColor = `rgba(231, 76, 60, ${correlation})`;
            cell.textContent = `${(correlation * 100).toFixed(0)}%`;
            cell.title = `Hour: ${hour}:00, Weather: ${weather}, Correlation: ${(
              correlation * 100
            ).toFixed(1)}%`;

            row.appendChild(cell);
          });

          timeGrid.appendChild(row);
        });

        timeContent.appendChild(timeGrid);
        timeWeatherContainer.appendChild(timeContent);
      }

      // Create insights cards
      function createInsights(recommendations) {
        const container = document.getElementById("insightsContainer");
        container.innerHTML = "";

        recommendations.forEach((rec) => {
          const card = document.createElement("div");
          card.className = `insight-card ${rec.type}`;

          card.innerHTML = `
                    <div class="insight-title">${getInsightIcon(
                      rec.category
                    )} ${rec.category.toUpperCase()}</div>
                    <div class="insight-message">${rec.message}</div>
                    <div class="insight-suggestion">üí° ${rec.suggestion}</div>
                `;

          container.appendChild(card);
        });
      }

      // Get icon for insight category
      function getInsightIcon(category) {
        const icons = {
          weather: "üå§Ô∏è",
          vehicle_type: "üöõ",
          time: "‚è∞",
        };
        return icons[category] || "üí°";
      }

      // Update statistics
      function updateStats(dataPoints) {
        document.getElementById("totalVehicles").textContent = dataPoints;
        document.getElementById("overallCompliance").textContent = "50%";
        document.getElementById("avgReactionTime").textContent = "2.9s";
        document.getElementById("weatherConditions").textContent = "4";
      }

      // Update data table
      function updateDataTable(data) {
        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = "";

        data.forEach((item) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${item.tracker_id}</td>
                    <td>${item.vehicle_type}</td>
                    <td>${item.status}</td>
                    <td>${item.compliance === 1 ? "‚úÖ" : "‚ùå"}</td>
                    <td>${item.reaction_time || "-"}</td>
                    <td>${item.weather_condition || "-"}</td>
                    <td>${item.temperature || "-"}¬∞C</td>
                    <td>${item.date}</td>
                `;
          tbody.appendChild(row);
        });
      }

      // Apply filters
      async function applyFilters() {
        const weather = document.getElementById("weatherFilter").value;
        const vehicle = document.getElementById("vehicleFilter").value;
        const compliance = document.getElementById("complianceFilter").value;

        let url = "http://localhost:8000/tracking-data/filter/?limit=50";

        if (weather) url += `&weather_condition=${weather}`;
        if (vehicle) url += `&vehicle_type=${vehicle}`;
        if (compliance !== "") url += `&compliance=${compliance}`;

        try {
          const response = await fetch(url);
          const data = await response.json();

          if (data.status === "success") {
            updateDataTable(data.data);
          }
        } catch (error) {
          console.error("Error applying filters:", error);
          showError("Failed to apply filters");
        }
      }

      // Show loading state
      function showLoading() {
        // You can add a loading spinner here
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        document.querySelector(".content").prepend(errorDiv);

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }
    </script>
  </body>
</html>
